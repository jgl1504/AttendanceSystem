@page "/admin/leave/types"
@using WebApp.Shared.Model
@inject HttpClient Http

<PageTitle>Leave Types</PageTitle>

@if (isLoading)
{
    <h2>Leave Types</h2>
    <p class="text-muted">Configure leave types with accrual rules, pools, and requirements.</p>
    <p>Loading...</p>
}
else
{
    <h2>Leave Types</h2>
    <p class="text-muted">Configure leave types with accrual rules, pools, and requirements.</p>

    <EditForm Model="@editLeaveType" OnValidSubmit="@SaveLeaveType">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="row g-3 mb-4 p-3 border rounded bg-light">
            <h5>@(editLeaveType.Id == Guid.Empty ? "Add New Leave Type" : $"Edit: {editLeaveType.Name}")</h5>

            <!-- Basic Info -->
            <div class="col-md-4">
                <label class="form-label">Name <span class="text-danger">*</span></label>
                <InputText class="form-control" @bind-Value="editLeaveType.Name" />
                <ValidationMessage For="@(() => editLeaveType.Name)" />
            </div>

            <div class="col-md-4">
                <label class="form-label">Description</label>
                <InputText class="form-control" @bind-Value="editLeaveType.Description" />
            </div>

            <div class="col-md-2">
                <label class="form-label">Color</label>
                <input type="color" class="form-control form-control-color" @bind="editLeaveType.ColorCode" />
            </div>

            <div class="col-md-2">
                <label class="form-label">Sort Order</label>
                <InputNumber class="form-control" @bind-Value="editLeaveType.SortOrder" />
            </div>

            <!-- Pool Configuration -->
            <div class="col-md-4">
                <label class="form-label">Pool Type</label>
                <InputSelect class="form-select" @bind-Value="editLeaveType.PoolType">
                    <option value="@LeavePoolType.OwnPool">Own Pool (tracks balance)</option>
                    <option value="@LeavePoolType.UsesOtherPool">Uses Another Pool</option>
                    <option value="@LeavePoolType.Unlimited">Unlimited (no tracking)</option>
                    <option value="@LeavePoolType.OneTime">One-Time Allocation</option>
                </InputSelect>
                <ValidationMessage For="@(() => editLeaveType.PoolType)" />
            </div>

            @if (editLeaveType.PoolType == LeavePoolType.UsesOtherPool)
            {
                <div class="col-md-4">
                    <label class="form-label">Deduct From Pool</label>
                    <InputSelect class="form-select" @bind-Value="editLeaveType.PrimaryPoolLeaveTypeId">
                        <option value="">-- Select Pool --</option>
                        @foreach (var lt in poolTypes)
                        {
                            <option value="@lt.Id">@lt.Name</option>
                        }
                    </InputSelect>
                </div>
            }

            <div class="col-md-4">
                <label class="form-label">Fallback Pool (if exhausted)</label>
                <InputSelect class="form-select" @bind-Value="editLeaveType.FallbackPoolLeaveTypeId">
                    <option value="">-- None --</option>
                    @foreach (var lt in poolTypes.Where(p => p.Id != editLeaveType.Id))
                    {
                        <option value="@lt.Id">@lt.Name</option>
                    }
                </InputSelect>
            </div>

            <!-- Accrual Rules -->
            <div class="col-md-4">
                <label class="form-label">Accrual Type</label>
                <InputSelect class="form-select" @bind-Value="editLeaveType.AccrualType">
                    <option value="@LeaveAccrualType.Annual">Annual (days per year)</option>
                    <option value="@LeaveAccrualType.Cycle">Cycle (days per X months)</option>
                    <option value="@LeaveAccrualType.Fixed">Fixed (one-time amount)</option>
                    <option value="@LeaveAccrualType.Unlimited">Unlimited</option>
                    <option value="@LeaveAccrualType.None">None (no accrual)</option>
                </InputSelect>
                <ValidationMessage For="@(() => editLeaveType.AccrualType)" />
            </div>

            @if (editLeaveType.AccrualType == LeaveAccrualType.Annual || editLeaveType.AccrualType == LeaveAccrualType.Fixed)
            {
                <div class="col-md-2">
                    <label class="form-label">Days Per Year</label>
                    <InputNumber class="form-control" @bind-Value="editLeaveType.DaysPerYear" TValue="decimal" />
                    <ValidationMessage For="@(() => editLeaveType.DaysPerYear)" />
                </div>
            }

            @if (editLeaveType.AccrualType == LeaveAccrualType.Cycle)
            {
                <div class="col-md-2">
                    <label class="form-label">Days Per Cycle</label>
                    <InputNumber class="form-control" @bind-Value="editLeaveType.DaysPerCycle" TValue="decimal?" />
                    <ValidationMessage For="@(() => editLeaveType.DaysPerCycle)" />
                </div>
                <div class="col-md-2">
                    <label class="form-label">Cycle Duration (months)</label>
                    <InputNumber class="form-control" @bind-Value="editLeaveType.AccrualCycleDurationMonths" TValue="int?" />
                    <ValidationMessage For="@(() => editLeaveType.AccrualCycleDurationMonths)" />
                </div>
            }

            @if (editLeaveType.AccrualType == LeaveAccrualType.Annual)
            {
                <div class="col-md-2">
                    <label class="form-label">Allows Carryover</label>
                    <div class="form-check mt-2">
                        <InputCheckbox class="form-check-input" @bind-Value="editLeaveType.AllowsCarryover" />
                    </div>
                </div>

                @if (editLeaveType.AllowsCarryover)
                {
                    <div class="col-md-2">
                        <label class="form-label">Max Carryover Days</label>
                        <InputNumber class="form-control" @bind-Value="editLeaveType.MaxCarryoverDays" />
                        <ValidationMessage For="@(() => editLeaveType.MaxCarryoverDays)" />
                    </div>
                }
            }

            <!-- Request Rules -->
            <div class="col-md-2">
                <label class="form-label">Requires Document</label>
                <div class="form-check mt-2">
                    <InputCheckbox class="form-check-input" @bind-Value="editLeaveType.RequiresSupportingDocument" />
                </div>
            </div>

            <div class="col-md-2">
                <label class="form-label">Requires Approval</label>
                <div class="form-check mt-2">
                    <InputCheckbox class="form-check-input" @bind-Value="editLeaveType.RequiresApproval" />
                </div>
            </div>

            <div class="col-md-2">
                <label class="form-label">Min Notice (days)</label>
                <InputNumber class="form-control" @bind-Value="editLeaveType.MinNoticeDays" />
                <ValidationMessage For="@(() => editLeaveType.MinNoticeDays)" />
            </div>

            <div class="col-md-2">
                <label class="form-label">Max Consecutive (0=unlimited)</label>
                <InputNumber class="form-control" @bind-Value="editLeaveType.MaxConsecutiveDays" />
                <ValidationMessage For="@(() => editLeaveType.MaxConsecutiveDays)" />
            </div>

            <div class="col-md-2">
                <label class="form-label">Allows Half Days</label>
                <div class="form-check mt-2">
                    <InputCheckbox class="form-check-input" @bind-Value="editLeaveType.AllowsHalfDays" />
                </div>
            </div>

            <!-- Payment Rules -->
            <div class="col-md-2">
                <label class="form-label">Is Paid</label>
                <div class="form-check mt-2">
                    <InputCheckbox class="form-check-input" @bind-Value="editLeaveType.IsPaid" />
                </div>
            </div>

            @if (editLeaveType.IsPaid)
            {
                <div class="col-md-2">
                    <label class="form-label">Payment % (e.g., 66 for UIF)</label>
                    <InputNumber class="form-control" @bind-Value="editLeaveType.PaymentPercentage" TValue="decimal" />
                    <ValidationMessage For="@(() => editLeaveType.PaymentPercentage)" />
                </div>
            }

            <!-- Gender Rules -->
            <div class="col-md-2">
                <label class="form-label">Gender Specific</label>
                <div class="form-check mt-2">
                    <InputCheckbox class="form-check-input" @bind-Value="editLeaveType.IsGenderSpecific" />
                </div>
            </div>

            @if (editLeaveType.IsGenderSpecific)
            {
                <div class="col-md-2">
                    <label class="form-label">Required Gender</label>
                    <InputSelect class="form-select" @bind-Value="editLeaveType.RequiredGender">
                        <option value="">-- Select --</option>
                        <option value="@Gender.Male">Male</option>
                        <option value="@Gender.Female">Female</option>
                        <option value="@Gender.Other">Other</option>
                    </InputSelect>
                    <ValidationMessage For="@(() => editLeaveType.RequiredGender)" />
                </div>
            }

            <div class="col-md-2">
                <label class="form-label">Active</label>
                <div class="form-check mt-2">
                    <InputCheckbox class="form-check-input" @bind-Value="editLeaveType.IsActive" />
                </div>
            </div>

            <!-- Submit Buttons -->
            <div class="col-12">
                <button type="submit" class="btn btn-primary me-2">
                    @(editLeaveType.Id == Guid.Empty ? "Add Leave Type" : "Save Changes")
                </button>
                @if (editLeaveType.Id != Guid.Empty)
                {
                    <button type="button" class="btn btn-secondary" @onclick="CancelEdit">Cancel</button>
                }
            </div>
        </div>
    </EditForm>

    <hr />

    <h4>Existing Leave Types</h4>

    @if (leaveTypes is null || !leaveTypes.Any())
    {
        <p class="text-muted">No leave types configured yet.</p>
    }
    else
    {
        <table class="table table-sm table-hover align-middle">
            <thead>
                <tr>
                    <th>Order</th>
                    <th>Name</th>
                    <th>Pool Type</th>
                    <th>Accrual</th>
                    <th>Days/Year</th>
                    <th>Requires Doc</th>
                    <th>Half Days</th>
                    <th>Active</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var lt in leaveTypes)
                {
                    <tr class="@(!lt.IsActive ? "table-secondary" : null)">
                        <td>@lt.SortOrder</td>
                        <td>
                            <span class="badge" style="background-color: @lt.ColorCode;">@lt.Name</span>
                        </td>
                        <td>@lt.PoolType</td>
                        <td>@lt.AccrualType</td>
                        <td>
                            @if (lt.AccrualType == LeaveAccrualType.Annual || lt.AccrualType == LeaveAccrualType.Fixed)
                            {
                                @lt.DaysPerYear
                            }
                            else if (lt.AccrualType == LeaveAccrualType.Cycle)
                            {
                                <span>@lt.DaysPerCycle / @lt.AccrualCycleDurationMonths mo</span>
                            }
                            else
                            {
                                <span>-</span>
                            }
                        </td>
                        <td>@(lt.RequiresSupportingDocument ? "Yes" : "No")</td>
                        <td>@(lt.AllowsHalfDays ? "Yes" : "No")</td>
                        <td>@(lt.IsActive ? "Yes" : "No")</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" @onclick="() => StartEdit(lt)">
                                Edit
                            </button>
                            @if (lt.IsActive)
                            {
                                <button class="btn btn-sm btn-outline-warning" @onclick="() => Deactivate(lt)">
                                    Deactivate
                                </button>
                            }
                            else
                            {
                                <button class="btn btn-sm btn-outline-success" @onclick="() => Activate(lt)">
                                    Activate
                                </button>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }

    <!-- help cards unchanged -->
    <hr class="my-5" />

    <div class="container">
        <!-- (keep all your existing help cards here, unchanged) -->
        @* ... help content omitted for brevity ... *@
    </div>
}

@code {
    private List<LeaveType> leaveTypes = new();
    private List<LeaveType> poolTypes = new();
    private LeaveType editLeaveType = new LeaveType { Id = Guid.Empty, IsActive = true };
    private bool isLoading = true;

    // Help section toggles
    private bool showPoolHelp = false;
    private bool showAccrualHelp = false;
    private bool showExamplesHelp = false;
    private bool showFieldHelp = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadLeaveTypes();
        await LoadPoolTypes();
        isLoading = false;
    }

    private async Task LoadLeaveTypes()
    {
        leaveTypes = await Http.GetFromJsonAsync<List<LeaveType>>("api/leavetypes") ?? new();
    }

    private async Task LoadPoolTypes()
    {
        poolTypes = await Http.GetFromJsonAsync<List<LeaveType>>("api/leavetypes/pools") ?? new();
    }

    private void StartEdit(LeaveType lt)
    {
        editLeaveType = new LeaveType
        {
            Id = lt.Id,
            Name = lt.Name,
            Description = lt.Description,
            ColorCode = lt.ColorCode,
            IsActive = lt.IsActive,
            PoolType = lt.PoolType,
            PrimaryPoolLeaveTypeId = lt.PrimaryPoolLeaveTypeId,
            FallbackPoolLeaveTypeId = lt.FallbackPoolLeaveTypeId,
            AccrualType = lt.AccrualType,
            DaysPerYear = lt.DaysPerYear,
            AccrualCycleDurationMonths = lt.AccrualCycleDurationMonths,
            DaysPerCycle = lt.DaysPerCycle,
            AllowsCarryover = lt.AllowsCarryover,
            MaxCarryoverDays = lt.MaxCarryoverDays,
            RequiresSupportingDocument = lt.RequiresSupportingDocument,
            RequiresApproval = lt.RequiresApproval,
            MinNoticeDays = lt.MinNoticeDays,
            MaxConsecutiveDays = lt.MaxConsecutiveDays,
            IsPaid = lt.IsPaid,
            PaymentPercentage = lt.PaymentPercentage,
            IsGenderSpecific = lt.IsGenderSpecific,
            RequiredGender = lt.RequiredGender,
            SortOrder = lt.SortOrder,
            AllowsHalfDays = lt.AllowsHalfDays
        };
    }

    private void CancelEdit()
    {
        editLeaveType = new LeaveType { Id = Guid.Empty, IsActive = true };
    }

    private async Task SaveLeaveType()
    {
        try
        {
            if (editLeaveType.Id == Guid.Empty)
            {
                var response = await Http.PostAsJsonAsync("api/leavetypes", editLeaveType);
                response.EnsureSuccessStatusCode();
            }
            else
            {
                var response = await Http.PutAsJsonAsync($"api/leavetypes/{editLeaveType.Id}", editLeaveType);
                response.EnsureSuccessStatusCode();
            }

            editLeaveType = new LeaveType { Id = Guid.Empty, IsActive = true };
            await LoadLeaveTypes();
            await LoadPoolTypes();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Save error: {ex.Message}");
        }
    }

    private async Task Deactivate(LeaveType lt)
    {
        lt.IsActive = false;
        await Http.PutAsJsonAsync($"api/leavetypes/{lt.Id}", lt);
        await LoadLeaveTypes();
    }

    private async Task Activate(LeaveType lt)
    {
        lt.IsActive = true;
        await Http.PutAsJsonAsync($"api/leavetypes/{lt.Id}", lt);
        await LoadLeaveTypes();
    }
}
