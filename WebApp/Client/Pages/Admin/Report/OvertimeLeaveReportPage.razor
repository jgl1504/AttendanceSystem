@page "/reports/overtime-leave"
@using WebApp.Shared.Model
@inject HttpClient Http

<PageTitle>Overtime, Leave & Saturdays Report</PageTitle>

<div class="container-fluid mt-4">
    <div class="row mb-3">
        <div class="col">
            <h3>Overtime, Leave & Saturdays Report</h3>
        </div>
    </div>

    <!-- Date & Employee Selector -->
    <div class="row mb-3">
        <div class="col-md-3">
            <label class="form-label">Start Date</label>
            <input type="date" class="form-control" @bind="startDate" />
        </div>
        <div class="col-md-3">
            <label class="form-label">End Date</label>
            <input type="date" class="form-control" @bind="endDate" />
        </div>
        <div class="col-md-3">
            <label class="form-label">Employee</label>
            <select class="form-select" @bind="selectedEmployeeId">
                <option value="0">All employees</option>
                @foreach (var e in employees)
                {
                    <option value="@e.Id">@e.Name</option>
                }
            </select>
        </div>
        <div class="col-md-3 d-flex align-items-end">
            <button class="btn btn-primary" @onclick="LoadReports">
                Load Report
            </button>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="text-center my-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading data...</p>
        </div>
    }
    else if (!string.IsNullOrWhiteSpace(errorMessage))
    {
        <div class="alert alert-danger" role="alert">
            @errorMessage
        </div>
    }
    else if (overtimeSummaries != null && leaveSummaries != null && saturdaySummaries != null)
    {
        <!-- Tabs -->
        <ul class="nav nav-tabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link @(activeTab == "overtime" ? "active" : "")"
                        @onclick="@(() => SetTab("overtime"))">
                    Overtime
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link @(activeTab == "leave" ? "active" : "")"
                        @onclick="@(() => SetTab("leave"))">
                    Leave
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link @(activeTab == "saturday" ? "active" : "")"
                        @onclick="@(() => SetTab("saturday"))">
                    Saturdays
                </button>
            </li>
        </ul>

        <div class="tab-content border border-top-0 p-3">
            @if (activeTab == "overtime")
            {
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Employee</th>
                                <th class="text-end">Normal Hours</th>
                                <th class="text-end">Weekday OT</th>
                                <th class="text-end">Sunday/PH OT</th>
                                <th class="text-end">Total OT</th>
                                <th class="text-end">Approved OT</th>
                                <th class="text-end">Unapproved OT</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var emp in overtimeSummaries)
                            {
                                var totalOT = emp.WeekdayOvertimeHours + emp.SundayPublicOvertimeHours;
                                <tr>
                                    <td>@emp.EmployeeName</td>
                                    <td class="text-end">@emp.NormalHours.ToString("0.00")</td>
                                    <td class="text-end">@emp.WeekdayOvertimeHours.ToString("0.00")</td>
                                    <td class="text-end">@emp.SundayPublicOvertimeHours.ToString("0.00")</td>
                                    <td class="text-end fw-bold">@totalOT.ToString("0.00")</td>
                                    <td class="text-end text-success">@emp.ApprovedOvertimeHours.ToString("0.00")</td>
                                    <td class="text-end text-warning">@emp.UnapprovedOvertimeHours.ToString("0.00")</td>
                                </tr>
                            }
                        </tbody>
                        <tfoot class="table-secondary fw-bold">
                            <tr>
                                <td>TOTAL</td>
                                <td class="text-end">@overtimeSummaries.Sum(x => x.NormalHours).ToString("0.00")</td>
                                <td class="text-end">@overtimeSummaries.Sum(x => x.WeekdayOvertimeHours).ToString("0.00")</td>
                                <td class="text-end">@overtimeSummaries.Sum(x => x.SundayPublicOvertimeHours).ToString("0.00")</td>
                                <td class="text-end">
                                    @overtimeSummaries.Sum(x => x.WeekdayOvertimeHours + x.SundayPublicOvertimeHours).ToString("0.00")
                                </td>
                                <td class="text-end">@overtimeSummaries.Sum(x => x.ApprovedOvertimeHours).ToString("0.00")</td>
                                <td class="text-end">@overtimeSummaries.Sum(x => x.UnapprovedOvertimeHours).ToString("0.00")</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            }
            else if (activeTab == "leave")
            {
                @if (leaveSummaries.Count == 0)
                {
                    <div class="alert alert-info">
                        No approved leave found for this period.
                    </div>
                }
                else
                {
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Employee</th>
                                    <th>Leave Type</th>
                                    <th class="text-end">Entitlement</th>
                                    <th class="text-end">Taken</th>
                                    <th class="text-end">Remaining</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var emp in leaveSummaries)
                                {
                                    @foreach (var lt in emp.LeaveTypes)
                                    {
                                        <tr>
                                            <td>@emp.EmployeeName</td>
                                            <td>@lt.LeaveTypeName</td>
                                            <td class="text-end">@lt.TotalEntitlement.ToString("0.00")</td>
                                            <td class="text-end">@lt.Taken.ToString("0.00")</td>
                                            <td class="text-end">@lt.Remaining.ToString("0.00")</td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                }
            }
            else if (activeTab == "saturday")
            {
                @if (saturdaySummaries.Count == 0)
                {
                    <div class="alert alert-info">
                        No Saturday work data for this period.
                    </div>
                }
                else
                {
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Employee</th>
                                    <th>Department</th>
                                    <th class="text-end">Expected Saturdays</th>
                                    <th class="text-end">Worked Saturdays</th>
                                    <th class="text-end">Missed Saturdays</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var emp in saturdaySummaries)
                                {
                                    <tr>
                                        <td>@emp.EmployeeName</td>
                                        <td>@emp.DepartmentName</td>
                                        <td class="text-end">@emp.ExpectedSaturdays</td>
                                        <td class="text-end">@emp.WorkedSaturdays</td>
                                        <td class="text-end fw-bold">@emp.MissedSaturdays</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            }
        </div>
    }
</div>

@code {
    private DateTime startDate = new DateTime(2025, 12, 16);
    private DateTime endDate = new DateTime(2026, 1, 15);

    private List<DriverOvertimeSummary>? overtimeSummaries;
    private List<LeaveSummary>? leaveSummaries;
    private List<SaturdayWorkSummary>? saturdaySummaries;

    private List<EmployeeDto> employees = new();
    private int selectedEmployeeId = 0; // 0 = All

    private bool isLoading = false;
    private string? errorMessage = null;
    private string activeTab = "overtime";

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Adjust endpoint name if your employees API is different
            employees = await Http.GetFromJsonAsync<List<EmployeeDto>>("api/employees")
                        ?? new List<EmployeeDto>();
        }
        catch
        {
            employees = new List<EmployeeDto>();
        }

        await LoadReports();
    }

    private void SetTab(string tab)
    {
        activeTab = tab;
    }

    private async Task LoadReports()
    {
        isLoading = true;
        errorMessage = null;
        overtimeSummaries = null;
        leaveSummaries = null;
        saturdaySummaries = null;

        try
        {
            var start = startDate.ToString("yyyy-MM-dd");
            var end = endDate.ToString("yyyy-MM-dd");
            var empParam = selectedEmployeeId > 0 ? $"&employeeId={selectedEmployeeId}" : string.Empty;

            var overtimeTask = Http.GetFromJsonAsync<List<DriverOvertimeSummary>>(
                $"api/report/overtime?startDate={start}&endDate={end}{empParam}");

            var leaveTask = Http.GetFromJsonAsync<List<LeaveSummary>>(
                $"api/report/leave?startDate={start}&endDate={end}{empParam}");

            var saturdayTask = Http.GetFromJsonAsync<List<SaturdayWorkSummary>>(
                $"api/report/saturdays?startDate={start}&endDate={end}{empParam}");

            await Task.WhenAll(overtimeTask, leaveTask, saturdayTask);

            overtimeSummaries = overtimeTask.Result ?? new List<DriverOvertimeSummary>();
            leaveSummaries = leaveTask.Result ?? new List<LeaveSummary>();
            saturdaySummaries = saturdayTask.Result ?? new List<SaturdayWorkSummary>();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading report: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }
}
