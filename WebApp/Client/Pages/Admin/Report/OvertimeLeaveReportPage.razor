@page "/reports/overtime-leave"
@using WebApp.Shared.Model
@inject HttpClient Http

<PageTitle>Overtime & Leave Report</PageTitle>

<div class="container-fluid mt-4">
    <div class="row mb-3">
        <div class="col">
            <h3>Overtime & Leave Report</h3>
        </div>
    </div>

    <!-- Date Range Selector -->
    <div class="row mb-3">
        <div class="col-md-3">
            <label class="form-label">Start Date</label>
            <input type="date" class="form-control" @bind="startDate" />
        </div>
        <div class="col-md-3">
            <label class="form-label">End Date</label>
            <input type="date" class="form-control" @bind="endDate" />
        </div>
        <div class="col-md-3 d-flex align-items-end">
            <button class="btn btn-primary" @onclick="LoadReports">
                Load Report
            </button>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="text-center my-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading data...</p>
        </div>
    }
    else if (!string.IsNullOrWhiteSpace(errorMessage))
    {
        <div class="alert alert-danger" role="alert">
            @errorMessage
        </div>
    }
    else if (overtimeSummaries != null && leaveSummaries != null)
    {
        <!-- Tabs -->
        <ul class="nav nav-tabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link @(activeTab == "overtime" ? "active" : "")"
                        @onclick="@(() => SetTab("overtime"))">
                    Overtime
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link @(activeTab == "leave" ? "active" : "")"
                        @onclick="@(() => SetTab("leave"))">
                    Leave
                </button>
            </li>
        </ul>

        <div class="tab-content border border-top-0 p-3">
            @if (activeTab == "overtime")
            {
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Employee</th>
                                <th class="text-end">Normal Hours</th>
                                <th class="text-end">Weekday OT</th>
                                <th class="text-end">Sunday/PH OT</th>
                                <th class="text-end">Total OT</th>
                                <th class="text-end">Approved OT</th>
                                <th class="text-end">Unapproved OT</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var emp in overtimeSummaries)
                            {
                                var totalOT = emp.WeekdayOvertimeHours + emp.SundayPublicOvertimeHours;
                                <tr>
                                    <td>@emp.EmployeeName</td>
                                    <td class="text-end">@emp.NormalHours.ToString("0.00")</td>
                                    <td class="text-end">@emp.WeekdayOvertimeHours.ToString("0.00")</td>
                                    <td class="text-end">@emp.SundayPublicOvertimeHours.ToString("0.00")</td>
                                    <td class="text-end fw-bold">@totalOT.ToString("0.00")</td>
                                    <td class="text-end text-success">@emp.ApprovedOvertimeHours.ToString("0.00")</td>
                                    <td class="text-end text-warning">@emp.UnapprovedOvertimeHours.ToString("0.00")</td>
                                </tr>
                            }
                        </tbody>
                        <tfoot class="table-secondary fw-bold">
                            <tr>
                                <td>TOTAL</td>
                                <td class="text-end">@overtimeSummaries.Sum(x => x.NormalHours).ToString("0.00")</td>
                                <td class="text-end">@overtimeSummaries.Sum(x => x.WeekdayOvertimeHours).ToString("0.00")</td>
                                <td class="text-end">@overtimeSummaries.Sum(x => x.SundayPublicOvertimeHours).ToString("0.00")</td>
                                <td class="text-end">
                                    @overtimeSummaries.Sum(x => x.WeekdayOvertimeHours + x.SundayPublicOvertimeHours).ToString("0.00")
                                </td>
                                <td class="text-end">@overtimeSummaries.Sum(x => x.ApprovedOvertimeHours).ToString("0.00")</td>
                                <td class="text-end">@overtimeSummaries.Sum(x => x.UnapprovedOvertimeHours).ToString("0.00")</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            }
            else if (activeTab == "leave")
            {
                @if (leaveSummaries.Count == 0)
                {
                    <div class="alert alert-info">
                        No approved leave found for this period.
                    </div>
                }
                else
                {
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Employee</th>
                                    <th>Leave Type</th>
                                    <th class="text-end">Entitlement</th>
                                    <th class="text-end">Taken</th>
                                    <th class="text-end">Remaining</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var emp in leaveSummaries)
                                {
                                    @foreach (var lt in emp.LeaveTypes)
                                    {
                                        <tr>
                                            <td>@emp.EmployeeName</td>
                                            <td>@lt.LeaveTypeName</td>
                                            <td class="text-end">@lt.TotalEntitlement.ToString("0.00")</td>
                                            <td class="text-end">@lt.Taken.ToString("0.00")</td>
                                            <td class="text-end">@lt.Remaining.ToString("0.00")</td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                }
            }
        </div>
    }
</div>

@code {
    private DateTime startDate = new DateTime(2025, 12, 16);
    private DateTime endDate = new DateTime(2026, 1, 15);

    private List<DriverOvertimeSummary>? overtimeSummaries;
    private List<LeaveSummary>? leaveSummaries;

    private bool isLoading = false;
    private string? errorMessage = null;
    private string activeTab = "overtime";

    protected override async Task OnInitializedAsync()
    {
        await LoadReports();
    }

    private void SetTab(string tab)
    {
        activeTab = tab;
    }

    private async Task LoadReports()
    {
        isLoading = true;
        errorMessage = null;
        overtimeSummaries = null;
        leaveSummaries = null;

        try
        {
            var start = startDate.ToString("yyyy-MM-dd");
            var end = endDate.ToString("yyyy-MM-dd");

            var overtimeTask = Http.GetFromJsonAsync<List<DriverOvertimeSummary>>(
                $"api/report/overtime?startDate={start}&endDate={end}");

            var leaveTask = Http.GetFromJsonAsync<List<LeaveSummary>>(
                $"api/report/leave?startDate={start}&endDate={end}");

            await Task.WhenAll(overtimeTask, leaveTask);

            overtimeSummaries = overtimeTask.Result ?? new List<DriverOvertimeSummary>();
            leaveSummaries = leaveTask.Result ?? new List<LeaveSummary>();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading report: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }
}
