@page "/admin/report/payroll"
@using System.Globalization
@using WebApp.Shared.Model.Payroll
@using WebApp.Shared.Model
@using WebApp.Shared.Model.Constants
@inject HttpClient Http

<PageTitle>Payroll Reports</PageTitle>

<div class="container-fluid mt-4">
    <div class="row mb-3">
        <div class="col">
            <h3>Payroll Reports</h3>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-md-2">
            <label class="form-label">Year</label>
            <InputNumber TValue="int" @bind-Value="SelectedYear" class="form-control" />
        </div>
        <div class="col-md-3">
            <label class="form-label">Month</label>
            <InputSelect TValue="int" @bind-Value="SelectedMonth" class="form-select">
                @foreach (var m in Months)
                {
                    <option value="@m.Value">@m.Text</option>
                }
            </InputSelect>
        </div>
        <div class="col-md-3">
            <label class="form-label">Company</label>
            <InputSelect TValue="string"
                         @bind-Value="SelectedCompanyId"
                         @onchange="OnCompanyChanged"
                         class="form-select">
                <option value="">All</option>
                @foreach (var c in Companies)
                {
                    <option value="@c.Id">@c.Name</option>
                }
            </InputSelect>
        </div>
        <div class="col-md-2">
            <label class="form-label">Department</label>
            <InputSelect TValue="string"
                         @bind-Value="SelectedDepartmentId"
                         class="form-select">
                <option value="">All</option>
                @foreach (var d in Departments)
                {
                    <option value="@d.Id">@d.Name</option>
                }
            </InputSelect>
        </div>
        <div class="col-md-2">
            <label class="form-label">Employee</label>
            <InputSelect TValue="string"
                         @bind-Value="SelectedEmployeeId"
                         class="form-select">
                <option value="">All</option>
                @foreach (var e in Employees)
                {
                    <option value="@e.Id">@e.DisplayName</option>
                }
            </InputSelect>
        </div>
    </div>

    <div class="mb-3">
        <button class="btn btn-primary me-2" @onclick="OnReloadClicked" disabled="@IsLoading">
            @(IsLoading ? "Loading..." : "Load Payroll Data")
        </button>
    </div>

    <div class="mb-2">
        <div>
            <strong>Time & overtime period:</strong>
            @PayrollStart.ToString("yyyy-MM-dd") to @PayrollEnd.AddDays(-1).ToString("yyyy-MM-dd")
        </div>
        <div>
            <strong>Leave (Payroll) balances as at end of previous month:</strong>
            @PrevMonthStart.ToString("yyyy-MM-dd") to @PrevMonthEnd.ToString("yyyy-MM-dd")
        </div>
    </div>

    @if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <div class="alert alert-danger">@ErrorMessage</div>
    }

    @if (IsLoading)
    {
        <div class="text-center my-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading data...</p>
        </div>
    }
    else
    {
        <ul class="nav nav-tabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link @(activeTab == "time" ? "active" : "")"
                        @onclick="@(() => SetTab("time"))">
                    Time & Overtime
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link @(activeTab == "leavePayroll" ? "active" : "")"
                        @onclick="@(() => SetTab("leavePayroll"))">
                    Leave (Payroll)
                </button>
            </li>
        </ul>

        <div class="tab-content border border-top-0 p-3">
            @if (activeTab == "time")
            {
                @if ((WeeklySummaries is null && TimeSummaries is null) && (OvertimeItems is null))
                {
                    <p>No data loaded.</p>
                }
                else
                {
                    <h5>Weekly breakdown</h5>

                    @if (WeeklySummaries is null || !WeeklySummaries.Any())
                    {
                        <p>No weekly records for selected period.</p>
                    }
                    else
                    {
                        var employeesWeekly = WeeklySummaries
                        .GroupBy(w => new { w.EmployeeId, w.Name })
                        .ToList();

                        <div class="table-responsive mb-3">
                            <table class="table table-sm table-striped table-bordered align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>Employee</th>
                                        @foreach (var w in MonthWeeks)
                                        {
                                            <th class="text-center">
                                                Week @w.Index<br />
                                                <small>@w.Start.ToString("dd")–@w.End.ToString("dd")</small>
                                            </th>
                                        }
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var emp in employeesWeekly)
                                    {
                                        <tr>
                                            <td>@emp.Key.Name</td>

                                            @foreach (var w in MonthWeeks)
                                            {
                                                var week = emp.FirstOrDefault(x => x.WeekIndex == w.Index);

                                                if (week is null)
                                                {
                                                    <td class="text-end text-muted">0 / 0 / 0 / 0</td>
                                                }
                                                else
                                                {
                                                    <td class="text-end">
                                                        @week.NormalHours.ToString("0.00") /
                                                        @week.OvertimeApproved.ToString("0.00") /
                                                        @week.OvertimeSundayApproved.ToString("0.00") /
                                                        @week.DriverApproved.ToString("0.00")
                                                    </td>
                                                }
                                            }
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>

                        <p class="text-muted">
                            Format per week column: Normal / OT Approved / OT Sunday / Driver.
                        </p>
                    }

                    <h5>Monthly totals</h5>

                    @if (TimeSummaries is null || !TimeSummaries.Any())
                    {
                        <p>No monthly summary records for selected period.</p>
                    }
                    else
                    {
                        <div class="table-responsive mb-3">
                            <table class="table table-sm table-striped table-bordered align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>Employee</th>
                                        <th class="text-end">Normal Hours</th>
                                        <th class="text-end">OT Approved</th>
                                        <th class="text-end">OT Sunday Approved</th>
                                        <th class="text-end">Driver Approved</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var row in TimeSummaries)
                                    {
                                        <tr>
                                            <td>@row.EmployeeName</td>
                                            <td class="text-end">@row.NormalHours.ToString("0.00")</td>
                                            <td class="text-end">@row.OvertimeApproved.ToString("0.00")</td>
                                            <td class="text-end">@row.OvertimeSundayApproved.ToString("0.00")</td>
                                            <td class="text-end">@row.DriverApproved.ToString("0.00")</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }

                    <h5>Overtime detail</h5>

                    @if (OvertimeItems is null)
                    {
                        <p>No overtime data loaded.</p>
                    }
                    else if (!OvertimeItems.Any())
                    {
                        <p>No overtime records for selected period.</p>
                    }
                    else
                    {
                        <div class="table-responsive">
                            <table class="table table-sm table-striped table-bordered align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>Date</th>
                                        <th>Employee</th>
                                        <th>Department</th>
                                        <th class="text-end">Hours</th>
                                        <th>Type</th>
                                        <th>Approved</th>
                                        <th>Notes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var ot in OvertimeItems)
                                    {
                                        <tr>
                                            <td>@ot.Date.ToString("yyyy-MM-dd")</td>
                                            <td>@ot.EmployeeName</td>
                                            <td>@ot.DepartmentName</td>
                                            <td class="text-end">@ot.Hours.ToString("0.00")</td>
                                            <td>@ot.Type</td>
                                            <td>@(ot.IsApproved ? "Yes" : "No")</td>
                                            <td>@ot.Notes</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                }
            }
            else if (activeTab == "leavePayroll")
            {
                @if (PayrollLeaveMatrix is null)
                {
                    <p>Click "Load Payroll Data" to view leave balances per employee (as at end of previous month).</p>
                }
                else if (!PayrollLeaveMatrix.Any())
                {
                    <p>No leave balances for this period.</p>
                }
                else
                {
                    <div class="table-responsive">
                        <table class="table table-sm table-striped table-bordered align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Name</th>
                                    <th class="text-end">AnnualLeave</th>
                                    <th class="text-end">PaternityLeave</th>
                                    <th class="text-end">MaternityLeave</th>
                                    <th class="text-end">SickLeave</th>
                                    <th class="text-end">UnpaidLeave</th>
                                    <th class="text-end">FamilyResponsibility</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var row in PayrollLeaveMatrix)
                                {
                                    <tr>
                                        <td>@row.EmployeeName</td>
                                        <td class="text-end">@row.AnnualLeave.ToString("0.##")</td>
                                        <td class="text-end">@row.PaternityLeave.ToString("0.##")</td>
                                        <td class="text-end">@row.MaternityLeave.ToString("0.##")</td>
                                        <td class="text-end">@row.SickLeave.ToString("0.##")</td>
                                        <td class="text-end">@row.UnpaidLeave.ToString("0.##")</td>
                                        <td class="text-end">@row.FamilyResponsibility.ToString("0.##")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <p class="text-muted">
                        Balances as at end of previous month for Annual, Paternity, Maternity,
                        Sick, Unpaid, and Family Responsibility leave.
                    </p>

                    <p class="mt-3">
                        <strong>Leave calculation rules:</strong><br />
                        @GetLeaveAccrualExplanation()
                    </p>
                }
            }
        </div>
    }
</div>

@code {
    private string activeTab = "time";

    private int SelectedYear = DateTime.Today.Year;
    private int SelectedMonth = DateTime.Today.Month; // 1–12

    private string? SelectedCompanyId;
    private string? SelectedDepartmentId;
    private string? SelectedEmployeeId;

    private bool IsLoading;
    private string? ErrorMessage;

    private List<SelectItem> Months = new();
    private List<CompanyDto> Companies = new();
    private List<DepartmentDto> Departments = new();
    private List<SimpleEmployeeDto> AllEmployees = new();
    private List<SimpleEmployeeDto> Employees = new();

    private List<PayrollHoursRowDto>? TimeSummaries;
    private List<PayrollWeeklySummaryDto>? WeeklySummaries = new();
    private List<PayrollOvertimeItemDto>? OvertimeItems = new();

    private List<PayrollLeaveRowDto>? PayrollLeaveMatrix;

    // Full calendar month (used only for previous-month leave calculations)
    private DateTime MonthStart => new DateTime(SelectedYear, SelectedMonth, 1);
    private DateTime MonthEnd => MonthStart.AddMonths(1).AddDays(-1);

    // Leave (Payroll) balances use previous month
    private DateTime PrevMonthStart
    {
        get
        {
            var cur = new DateTime(SelectedYear, SelectedMonth, 1);
            var prev = cur.AddMonths(-1);
            return new DateTime(prev.Year, prev.Month, 1);
        }
    }
    private DateTime PrevMonthEnd => PrevMonthStart.AddMonths(1).AddDays(-1);

    // Time & overtime payroll period: 15th of selected month to 16th of next month (exclusive)
    private DateTime PayrollStart
    {
        get
        {
            return new DateTime(SelectedYear, SelectedMonth, 15);
        }
    }

    private DateTime PayrollEnd
    {
        get
        {
            var start = PayrollStart;
            return start.AddMonths(1).AddDays(1); // exclusive upper bound (16th of next month)
        }
    }

    private List<WeekRange> MonthWeeks = new();

    protected override async Task OnInitializedAsync()
    {
        BuildMonths();
        BuildMonthWeeks();
        await LoadLookups();
        await LoadPayrollData();
    }

    private void SetTab(string tab) => activeTab = tab;

    private async Task OnReloadClicked()
    {
        BuildMonthWeeks();
        await LoadPayrollData();
    }

    private void BuildMonths()
    {
        Months = Enumerable.Range(1, 12)
            .Select(m => new SelectItem
            {
                Value = m,
                Text = CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(m)
            })
            .ToList();
    }

    // Weekly ranges based on PayrollStart/PayrollEnd
    private void BuildMonthWeeks()
    {
        MonthWeeks.Clear();

        var start = PayrollStart;
        var end = PayrollEnd.AddDays(-1); // inclusive last day in the range

        var currentStart = start;
        var currentEnd = currentStart;

        while (currentEnd.DayOfWeek != DayOfWeek.Sunday && currentEnd < end)
            currentEnd = currentEnd.AddDays(1);

        int index = 1;
        MonthWeeks.Add(new WeekRange { Index = index, Start = currentStart, End = currentEnd });

        while (currentEnd < end)
        {
            index++;
            currentStart = currentEnd.AddDays(1);
            currentEnd = currentStart.AddDays(6);
            if (currentEnd > end) currentEnd = end;

            MonthWeeks.Add(new WeekRange { Index = index, Start = currentStart, End = currentEnd });
        }
    }

    private async Task LoadLookups()
    {
        ErrorMessage = null;

        try
        {
            Companies =
                await Http.GetFromJsonAsync<List<CompanyDto>>("api/company")
                ?? new List<CompanyDto>();

            Departments =
                await Http.GetFromJsonAsync<List<DepartmentDto>>("api/departments")
                ?? new List<DepartmentDto>();

            var employeesFull =
                await Http.GetFromJsonAsync<List<WebApp.Shared.Model.EmployeeDto>>("api/employees")
                ?? new List<WebApp.Shared.Model.EmployeeDto>();

            AllEmployees = employeesFull
                .OrderBy(e => e.Name)
                .Select(e => new SimpleEmployeeDto
                {
                    Id = e.Id.ToString(),
                    DisplayName = e.Name,
                    CompanyId = e.CompanyId,
                    DepartmentId = e.DepartmentId
                })
                .ToList();

            Employees = AllEmployees.ToList();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error loading lookup data: {ex.Message}";
        }
    }

    private async Task LoadPayrollData()
    {
        ErrorMessage = null;
        IsLoading = true;

        try
        {
            var timeFrom = PayrollStart;
            var timeTo = PayrollEnd;

            try
            {
                var payrollUrl =
                    $"api/attendance/payroll-hours" +
                    $"?from={timeFrom:yyyy-MM-dd}" +
                    $"&to={timeTo:yyyy-MM-dd}" +
                    (string.IsNullOrEmpty(SelectedCompanyId) ? "" : $"&companyId={SelectedCompanyId}") +
                    (string.IsNullOrEmpty(SelectedEmployeeId) ? "" : $"&employeeId={SelectedEmployeeId}") +
                    (string.IsNullOrEmpty(SelectedDepartmentId) ? "" : $"&departmentId={SelectedDepartmentId}");

                TimeSummaries = await Http.GetFromJsonAsync<List<PayrollHoursRowDto>>(payrollUrl)
                                ?? new List<PayrollHoursRowDto>();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"ERROR TimeSummaries: {ex.Message}");
                TimeSummaries = new List<PayrollHoursRowDto>();
            }

            try
            {
                var overtimeUrl =
                    $"api/attendance/overtime-detail" +
                    $"?from={timeFrom:yyyy-MM-dd}" +
                    $"&to={timeTo:yyyy-MM-dd}" +
                    (string.IsNullOrEmpty(SelectedCompanyId) ? "" : $"&companyId={SelectedCompanyId}") +
                    (string.IsNullOrEmpty(SelectedEmployeeId) ? "" : $"&employeeId={SelectedEmployeeId}") +
                    (string.IsNullOrEmpty(SelectedDepartmentId) ? "" : $"&departmentId={SelectedDepartmentId}");

                OvertimeItems =
                    await Http.GetFromJsonAsync<List<PayrollOvertimeItemDto>>(overtimeUrl)
                    ?? new List<PayrollOvertimeItemDto>();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"ERROR OvertimeItems: {ex.Message}");
                OvertimeItems = new List<PayrollOvertimeItemDto>();
            }

            try
            {
                var payrollMatrixUrl =
                    $"api/leave/payroll-matrix?year={SelectedYear}&month={SelectedMonth}" +
                    (string.IsNullOrEmpty(SelectedCompanyId) ? "" : $"&companyId={SelectedCompanyId}") +
                    (string.IsNullOrEmpty(SelectedDepartmentId) ? "" : $"&departmentId={SelectedDepartmentId}") +
                    (string.IsNullOrEmpty(SelectedEmployeeId) ? "" : $"&employeeId={SelectedEmployeeId}");

                PayrollLeaveMatrix =
                    await Http.GetFromJsonAsync<List<PayrollLeaveRowDto>>(payrollMatrixUrl)
                    ?? new List<PayrollLeaveRowDto>();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"ERROR PayrollLeaveMatrix: {ex.Message}");
                PayrollLeaveMatrix = new List<PayrollLeaveRowDto>();
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error loading payroll data: {ex.Message}";
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task OnCompanyChanged(ChangeEventArgs e)
    {
        SelectedCompanyId = e.Value?.ToString();
        FilterEmployeesList();
        await LoadPayrollData();
    }

    private void FilterEmployeesList()
    {
        IEnumerable<SimpleEmployeeDto> query = AllEmployees;

        if (!string.IsNullOrEmpty(SelectedCompanyId) && int.TryParse(SelectedCompanyId, out var cid))
        {
            query = query.Where(emp => emp.CompanyId == cid);
        }

        Employees = query.OrderBy(emp => emp.DisplayName).ToList();

        if (!string.IsNullOrEmpty(SelectedEmployeeId) &&
            !Employees.Any(e => e.Id == SelectedEmployeeId))
        {
            SelectedEmployeeId = null;
        }
    }

    private string GetLeaveAccrualExplanation()
    {
        var cutOff = LeaveConstants.AccrualHireDateCutOff.ToString("yyyy-MM-dd");

        return
            $"Annual leave accrues monthly at 1.25 days per month for a 5-day week " +
            $"and 1.5 days per month for a 6-day week. " +
            $"Sick leave is 30 days over a 3-year cycle; no sick leave can be taken " +
            $"in the first 4 months of employment. " +
            $"Accrual rules based on hire dates are applied from the cut-off date {cutOff}.";
    }

    public class SelectItem
    {
        public int Value { get; set; }
        public string Text { get; set; } = string.Empty;
    }

    public class CompanyDto
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
    }

    public class DepartmentDto
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
    }

    public class SimpleEmployeeDto
    {
        public string Id { get; set; } = string.Empty;
        public string DisplayName { get; set; } = string.Empty;
        public int CompanyId { get; set; }
        public int DepartmentId { get; set; }
    }

    public class WeekRange
    {
        public int Index { get; set; }
        public DateTime Start { get; set; }
        public DateTime End { get; set; }
    }

    public class PayrollWeeklySummaryDto
    {
        public string EmployeeId { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;

        public int WeekIndex { get; set; }
        public DateTime WeekStart { get; set; }
        public DateTime WeekEnd { get; set; }

        public decimal NormalHours { get; set; }
        public decimal OvertimeApproved { get; set; }
        public decimal OvertimeSundayApproved { get; set; }
        public decimal DriverApproved { get; set; }
    }

    public class PayrollOvertimeItemDto
    {
        public DateTime Date { get; set; }
        public string EmployeeId { get; set; } = string.Empty;
        public string EmployeeName { get; set; } = string.Empty;
        public string DepartmentName { get; set; } = string.Empty;
        public decimal Hours { get; set; }
        public string Type { get; set; } = string.Empty;
        public bool IsApproved { get; set; }
        public string? Notes { get; set; }
    }

    public class PayrollLeaveItemDto
    {
        public string EmployeeId { get; set; } = string.Empty;
        public string EmployeeName { get; set; } = string.Empty;
        public string DepartmentName { get; set; } = string.Empty;
        public string Type { get; set; } = string.Empty;
        public DateTime FromDate { get; set; }
        public DateTime ToDate { get; set; }
        public decimal Hours { get; set; }
        public string? Notes { get; set; }
    }
}
