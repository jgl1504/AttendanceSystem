@page "/register"
@using System.ComponentModel.DataAnnotations
@using WebApp.Shared.Model
@inject HttpClient Http
@inject NavigationManager Nav

<h3>First-time registration</h3>

@if (!string.IsNullOrEmpty(message))
{
    <div class="alert @(success ? "alert-success" : "alert-danger")">
        @message
    </div>
}

<EditForm Model="model" OnValidSubmit="HandleRegister">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="mb-3">
        <label class="form-label">Email</label>
        <InputText class="form-control" @bind-Value="model.Email" />
        <ValidationMessage For="@(() => model.Email)" />
    </div>

    <div class="mb-3">
        <label class="form-label">Password</label>
        <InputText class="form-control" type="password" @bind-Value="model.Password" />
        <ValidationMessage For="@(() => model.Password)" />
    </div>

    <div class="mb-3">
        <label class="form-label">Confirm password</label>
        <InputText class="form-control" type="password" @bind-Value="model.ConfirmPassword" />
        <ValidationMessage For="@(() => model.ConfirmPassword)" />
    </div>

    <button type="submit" class="btn btn-primary">Register</button>
</EditForm>

@code {
    private RegisterModel model = new();
    private string? message;
    private bool success;

    private async Task HandleRegister()
    {
        message = null;
        success = false;

        try
        {
            var request = new
            {
                email = model.Email,
                password = model.Password
            };

            var response = await Http.PostAsJsonAsync("api/auth/register", request);
            if (response.IsSuccessStatusCode)
            {
                success = true;
                var result = await response.Content.ReadFromJsonAsync<ServiceResponse<int>>();
                message = result?.Message ?? "Password set successfully. You can now log in.";
                // Optional redirect:
                // await Task.Delay(1500);
                // Nav.NavigateTo("/login");
            }
            else
            {
                var error = await response.Content.ReadFromJsonAsync<ServiceResponse<int>>();
                message = error?.Message ?? "Registration failed.";
            }
        }
        catch
        {
            message = "Registration failed.";
        }
    }

    public class RegisterModel
    {
        [Required]
        [EmailAddress]
        public string Email { get; set; } = string.Empty;

        [Required]
        [MinLength(6, ErrorMessage = "Password must be at least 6 characters.")]
        public string Password { get; set; } = string.Empty;

        [Required]
        [Compare(nameof(Password), ErrorMessage = "Passwords do not match.")]
        public string ConfirmPassword { get; set; } = string.Empty;
    }
}
