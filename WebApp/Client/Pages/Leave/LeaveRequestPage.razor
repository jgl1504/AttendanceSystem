@page "/leave/request"
@using WebApp.Shared.Model
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@inject HttpClient Http
@inject IJSRuntime JS

<h3>Leave Request</h3>

<AuthorizeView>
    <Authorized>
        @if (employees is null || departments is null || leaveTypes is null)
        {
            <p>Loading data...</p>
        }
        else
        {
            <div class="row mb-3">
                <div class="col-md-3 col-12 mb-2">
                    <label class="form-label">Department</label>
                    <select class="form-select" @bind="SelectedDepartmentId">
                        <option value="">-- All departments --</option>
                        @foreach (var d in departments)
                        {
                            <option value="@d.Id">@d.Name</option>
                        }
                    </select>
                </div>

                <div class="col-md-3 col-12 mb-2">
                    <label class="form-label">Employee</label>
                    <select class="form-select" @bind="SelectedEmployeeId">
                        <option value="">-- Select employee --</option>
                        @foreach (var e in filteredEmployees)
                        {
                            <option value="@e.Id">@e.Name</option>
                        }
                    </select>
                </div>

                <div class="col-md-3 col-6 mb-2">
                    <label class="form-label">Start date</label>
                    <InputDate @bind-Value="StartDate" class="form-control" />
                </div>

                <div class="col-md-3 col-6 mb-2">
                    <label class="form-label">End date</label>
                    <InputDate @bind-Value="EndDate" class="form-control" />
                </div>

                <div class="col-md-4 col-6 mb-2">
                    <label class="form-label">Leave Type</label>
                    <select class="form-select" @bind="selectedLeaveTypeId" @oninput="OnLeaveTypeChanged">
                        <option value="">-- Select leave type --</option>
                        @foreach (var lt in leaveTypes)
                        {
                            <option value="@lt.Id">@lt.Name</option>
                        }
                    </select>
                </div>

                @if (AllowHalfDay)
                {
                    <div class="col-md-2 col-6 mb-2">
                        <label class="form-label">Portion</label>
                        <InputSelect @bind-Value="SelectedPortion" class="form-select">
                            <option value="@LeavePortion.FullDay">Full day</option>
                            <option value="@LeavePortion.HalfDay">Half day</option>
                        </InputSelect>
                    </div>
                }
            </div>

            @if (selectedLeaveType != null && selectedLeaveType.RequiresSupportingDocument)
            {
                <div class="alert alert-info mb-3">
                    <strong>@selectedLeaveType.Name</strong> requires a supporting document
                    (e.g., medical certificate, proof). Please upload after submitting or contact admin.
                </div>
            }

            @if (selectedLeaveType != null && selectedLeaveType.MinNoticeDays > 0)
            {
                <div class="alert alert-warning mb-3">
                    This leave type requires <strong>@selectedLeaveType.MinNoticeDays days</strong> notice.
                </div>
            }

            <div class="mb-3">
                <label class="form-label">Reason (optional)</label>
                <textarea class="form-control" rows="2" @bind="reason"></textarea>
            </div>

            @if (calculatedDays > 0)
            {
                var effectiveDays = GetEffectiveDays(calculatedDays, SelectedPortion);
                <p class="text-muted">
                    This request will use <strong>@effectiveDays</strong> day(s) of leave
                    (@calculatedDays working day(s), @SelectedPortion).
                </p>
            }

            <button class="btn btn-primary" @onclick="Submit" disabled="@isSubmitting">
                @(isSubmitting ? "Submitting..." : "Submit Leave Request")
            </button>

            <p class="mt-3 @(isError ? "text-danger" : "text-muted")">@statusMessage</p>

            @if (balanceSummary is not null && selectedLeaveType is not null)
            {
                var effectiveDays = calculatedDays > 0 ? GetEffectiveDays(calculatedDays, SelectedPortion) : 0;
                <div class="mt-3 alert alert-info">
                    <div>
                        <strong>@balanceSummary.LeaveTypeName</strong> pool:
                        <strong>@balanceSummary.TotalEntitlement</strong> total,
                        <strong>@balanceSummary.Taken</strong> used,
                        <strong>@balanceSummary.Remaining</strong> remaining.
                    </div>

                    @if (effectiveDays > 0)
                    {
                        <div class="mt-1">
                            This request uses <strong>@effectiveDays</strong> day(s),
                            remaining after approval would be
                            <strong>@(balanceSummary.Remaining - effectiveDays)</strong> day(s).
                        </div>
                    }
                </div>
            }

            @if (records is not null && records.Any())
            {
                var ordered = records
                .OrderByDescending(r => r.RequestedAt)
                .ThenByDescending(r => r.Id)
                .ToList();

                <h5 class="mt-4">Leave history</h5>
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Start</th>
                            <th>End</th>
                            <th>Days</th>
                            <th>Portion</th>
                            <th>Type</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var r in ordered)
                        {
                            <tr>
                                <td>@r.StartDate.ToString("yyyy-MM-dd")</td>
                                <td>@r.EndDate.ToString("yyyy-MM-dd")</td>
                                <td>@r.DaysTaken</td>
                                <td>@r.Portion</td>
                                <td>@r.LeaveTypeName</td>
                                <td>@r.Status</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
        }
    </Authorized>

    <NotAuthorized>
        <div class="alert alert-warning mt-3">
            You must be logged in to request leave. Please log in and try again.
        </div>
    </NotAuthorized>
</AuthorizeView>

@code {
    private List<EmployeeListItem>? employees;
    private List<EmployeeListItem> filteredEmployees = new();
    private List<DepartmentListItem>? departments;
    private List<LeaveType>? leaveTypes;
    private LeaveType? selectedLeaveType;

    private int? _selectedEmployeeId;
    private int? selectedDepartmentId;

    private DateTime startDate = DateTime.Today;
    private DateTime endDate = DateTime.Today;
    private string selectedLeaveTypeId = "";
    private LeavePortion selectedPortion = LeavePortion.FullDay;
    private string reason = string.Empty;

    // NEW: per-type pool summary instead of legacy EmployeeLeaveDto
    private LeaveBalanceSummaryDto? balanceSummary;
    private List<LeaveRecordDto>? records;

    private decimal calculatedDays = 0;

    private bool isSubmitting;
    private bool isError;
    private string statusMessage = string.Empty;

    private bool AllowHalfDay => selectedLeaveType?.AllowsHalfDays ?? true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            departments = await Http.GetFromJsonAsync<List<DepartmentListItem>>("api/departments") ?? new();
            employees = await Http.GetFromJsonAsync<List<EmployeeListItem>>("api/employees") ?? new();
            leaveTypes = await Http.GetFromJsonAsync<List<LeaveType>>("api/leavetypes/active") ?? new();
            filteredEmployees = employees.ToList();
        }
        catch
        {
            departments ??= new();
            employees ??= new();
            leaveTypes ??= new();
            filteredEmployees = employees.ToList();
            isError = true;
            statusMessage = "Failed to load data for leave request.";
        }

        RecalculateDays();
    }

    private void OnLeaveTypeChanged(ChangeEventArgs e)
    {
        var leaveTypeIdStr = e.Value?.ToString();
        if (Guid.TryParse(leaveTypeIdStr, out var leaveTypeId))
        {
            selectedLeaveType = leaveTypes?.FirstOrDefault(lt => lt.Id == leaveTypeId);
            selectedLeaveTypeId = leaveTypeIdStr!;

            if (selectedLeaveType is not null && !selectedLeaveType.AllowsHalfDays)
            {
                SelectedPortion = LeavePortion.FullDay;
            }

            // refresh per-type balance when type changes
            _ = LoadBalanceSummary();
        }
        else
        {
            selectedLeaveType = null;
            selectedLeaveTypeId = "";
            balanceSummary = null;
        }
    }

    private int? SelectedDepartmentId
    {
        get => selectedDepartmentId;
        set
        {
            selectedDepartmentId = value;
            FilterEmployees();
            _selectedEmployeeId = null;
            balanceSummary = null;
            records = null;
            RecalculateDays();
        }
    }

    private void FilterEmployees()
    {
        if (employees is null)
        {
            filteredEmployees = new();
            return;
        }

        if (!selectedDepartmentId.HasValue || selectedDepartmentId.Value == 0)
        {
            filteredEmployees = employees.ToList();
        }
        else
        {
            filteredEmployees = employees
                .Where(e => e.DepartmentId == selectedDepartmentId.Value)
                .ToList();
        }
    }

    private int? SelectedEmployeeId
    {
        get => _selectedEmployeeId;
        set
        {
            _selectedEmployeeId = value;
            _ = LoadEmployeeData();
            _ = LoadBalanceSummary();
            RecalculateDays();
        }
    }

    private LeavePortion SelectedPortion
    {
        get => selectedPortion;
        set
        {
            selectedPortion = value;
            RecalculateDays();
        }
    }

    private async Task LoadEmployeeData()
    {
        if (!_selectedEmployeeId.HasValue)
        {
            balanceSummary = null;
            records = null;
            return;
        }

        // history still uses LeaveRecords
        records = await Http.GetFromJsonAsync<List<LeaveRecordDto>>($"api/leave/employee/{_selectedEmployeeId.Value}");
        StateHasChanged();
    }

    private async Task LoadBalanceSummary()
    {
        if (!_selectedEmployeeId.HasValue || string.IsNullOrEmpty(selectedLeaveTypeId))
        {
            balanceSummary = null;
            return;
        }

        try
        {
            var url = $"api/leave/balance-summary/{_selectedEmployeeId.Value}/{selectedLeaveTypeId}";
            balanceSummary = await Http.GetFromJsonAsync<LeaveBalanceSummaryDto>(url);
            StateHasChanged();
        }
        catch
        {
            balanceSummary = null;
        }
    }

    private void RecalculateDays()
    {
        calculatedDays = CalculateWorkingDays(startDate, endDate);
    }

    private decimal CalculateWorkingDays(DateTime start, DateTime end)
    {
        if (end < start) return 0;

        decimal days = 0;
        var current = start.Date;
        var last = end.Date;

        while (current <= last)
        {
            if (current.DayOfWeek == DayOfWeek.Saturday)
            {
                days += 0.5m;
            }
            else if (current.DayOfWeek != DayOfWeek.Sunday)
            {
                days += 1m;
            }

            current = current.AddDays(1);
        }

        return days;
    }

    private decimal GetEffectiveDays(decimal workingDays, LeavePortion portion)
        => portion == LeavePortion.HalfDay ? workingDays * 0.5m : workingDays * 1.0m;

    private bool IsSundayOnlyRange(DateTime start, DateTime end)
    {
        if (start.Date == end.Date && start.DayOfWeek == DayOfWeek.Sunday)
            return true;

        var current = start.Date;
        var last = end.Date;

        while (current <= last)
        {
            if (current.DayOfWeek != DayOfWeek.Sunday)
                return false;

            current = current.AddDays(1);
        }

        return true;
    }

    private async Task Submit()
    {
        isError = false;
        statusMessage = string.Empty;

        if (!_selectedEmployeeId.HasValue)
        {
            isError = true;
            statusMessage = "Select an employee.";
            return;
        }

        if (string.IsNullOrEmpty(selectedLeaveTypeId))
        {
            isError = true;
            statusMessage = "Select a leave type.";
            return;
        }

        if (endDate < startDate)
        {
            isError = true;
            statusMessage = "End date cannot be before start date.";
            return;
        }

        if (IsSundayOnlyRange(startDate, endDate))
        {
            await JS.InvokeVoidAsync("showInfo", "You selected only Sunday. This is a non-working day and cannot be requested as leave.");
            return;
        }

        isSubmitting = true;

        var dto = new RequestLeaveDto
        {
            EmployeeId = _selectedEmployeeId.Value,
            LeaveTypeId = Guid.Parse(selectedLeaveTypeId),
            StartDate = startDate,
            EndDate = endDate,
            Reason = reason,
            Portion = SelectedPortion
        };

        var response = await Http.PostAsJsonAsync("api/leave/request", dto);

        isSubmitting = false;

        if (!response.IsSuccessStatusCode)
        {
            isError = true;
            statusMessage = "Failed to submit leave request. Check balance or dates.";
            return;
        }

        statusMessage = "Leave request submitted.";

        await LoadEmployeeData();
        await LoadBalanceSummary();
        RecalculateDays();
    }

    public class EmployeeListItem
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public int DepartmentId { get; set; }
    }

    public class DepartmentListItem
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
    }

    private DateTime StartDate
    {
        get => startDate;
        set
        {
            startDate = value;
            RecalculateDays();
        }
    }

    private DateTime EndDate
    {
        get => endDate;
        set
        {
            endDate = value;
            RecalculateDays();
        }
    }
}
